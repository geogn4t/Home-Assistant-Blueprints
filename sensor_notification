blueprint:
  name: "Notify when sensor drops below threshold (select notify targets)"
  description: >
    Sends a push notification to selected devices when a numeric sensor
    goes below a specified threshold. Includes custom message support.
  domain: automation
  input:
    target_sensor:
      name: Sensor
      description: Select the numeric sensor to monitor.
      selector:
        entity:
          domain: sensor

    threshold:
      name: Threshold
      description: Notify when the sensor value drops below this number.
      default: 30
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"

    custom_message:
      name: Custom Message
      description: Add a message to include with the notification.
      default: "Please check this device soon."
      selector:
        text:

    notify_targets:
      name: Notify Devices
      description: Select one or more mobile app notify targets.
      selector:
        entity:
          multiple: true
          domain: notify

mode: single

trigger:
  - platform: numeric_state
    entity_id: !input target_sensor
    below: !input threshold

variables:
  threshold: !input threshold
  custom_message: !input custom_message
  sensor_name: "{{ state_attr(trigger.entity_id, 'friendly_name') or trigger.entity_id }}"
  sensor_value: "{{ states(trigger.entity_id) }}"
  notify_targets: !input notify_targets

action:
  - repeat:
      for_each: "{{ notify_targets }}"
      sequence:
        - service: "{{ repeat.item }}"
          data:
            title: "⚠️ Sensor Alert"
            message: >
              {{ sensor_name }} dropped below {{ threshold }}%
              (currently {{ sensor_value }}%).
              {{ custom_message }}
