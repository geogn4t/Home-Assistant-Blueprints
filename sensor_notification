blueprint:
  name: "Notify when sensor drops below threshold (multi-person)"
  description: >
    Sends a push notification to selected people when a numeric sensor
    goes below a specified threshold. Automatically sends to each person's
    active mobile app device(s). Includes a custom message field.
  domain: automation
  input:
    target_sensor:
      name: Sensor
      description: Select the sensor to monitor.
      selector:
        entity:
          domain: sensor

    threshold:
      name: Threshold
      description: Notify when the sensor value drops below this number.
      default: 30
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"

    custom_message:
      name: Custom Message
      description: Add a message to include with the notification.
      default: "Please check this device soon."
      selector:
        text:

    notify_persons:
      name: People to Notify
      description: Select one or more people to receive the notification.
      selector:
        entity:
          domain: person
          multiple: true

mode: single

trigger:
  - platform: numeric_state
    entity_id: !input target_sensor
    below: !input threshold

variables:
  threshold: !input threshold
  custom_message: !input custom_message
  sensor_name: "{{ state_attr(trigger.entity_id, 'friendly_name') or trigger.entity_id }}"
  sensor_value: "{{ states(trigger.entity_id) }}"

action:
  - repeat:
      for_each: !input notify_persons
      sequence:
        - variables:
            person_entity: "{{ repeat.item }}"
            device_list: >
              {% set devices = expand(person_entity)
                   | selectattr('domain', 'eq', 'device_tracker')
                   | map(attribute='entity_id')
                   | list %}
              {% set mobile_devices = devices
                   | map('replace', 'device_tracker.', 'notify.mobile_app_')
                   | select('in', integration_entities('mobile_app'))
                   | list %}
              {{ mobile_devices }}
        - if:
            - condition: template
              value_template: "{{ device_list | count > 0 }}"
          then:
            - repe
