blueprint:
  name: "Notify when sensor drops below threshold (multi-person)"
  description: >
    Sends a push notification to selected people when a numeric sensor
    goes below a specified threshold. Automatically sends to each person's
    active mobile app device(s). Includes a custom message field.
  domain: automation
  input:
    target_sensor:
      name: Sensor
      description: Select the sensor to monitor.
      selector:
        entity:
          domain: sensor

    threshold:
      name: Threshold
      description: Notify when the sensor value drops below this number.
      default: 30
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"

    custom_message:
      name: Custom Message
      description: Add a message to include with the notification.
      default: "Please check this device soon."
      selector:
        text:

    notify_persons:
      name: People to Notify
      description: Select one or more people to receive the notification.
      selector:
        entity:
          domain: person
          multiple: true

mode: single

trigger:
  - platform: numeric_state
    entity_id: !input target_sensor
    below: !input threshold

variables:
  threshold: !input threshold
  custom_message: !input custom_message
  sensor_name: "{{ state_attr(trigger.entity_id, 'friendly_name') or trigger.entity_id }}"
  sensor_value: "{{ states(trigger.entity_id) }}"
  notify_persons: !input notify_persons

action:
  - repeat:
      for_each: "{{ notify_persons }}"
      sequence:
        - variables:
            person_entity: "{{ repeat.item }}"
            # Collect the person's related mobile_app notify targets
            notify_services: >
              {% set ns = namespace(services=[]) %}
              {% for s in integration_entities('mobile_app')
                   if s.startswith('notify.mobile_app_') %}
                {% set person = s | regex_replace('^notify\\.mobile_app_', '') %}
                {% if person_entity.split('.')[-1] in person %}
                  {% set ns.services = ns.services + [s] %}
                {% endif %}
              {% endfor %}
              {{ ns.services }}
        - choose:
            - conditions: "{{ notify_services | count > 0 }}"
              sequence:
                - repeat:
                    for_each: "{{ notify_services }}"
                    sequence:
                      - service: "{{ repeat.item }}"
                        data:
                          title: "⚠️ Sensor Alert"
                          message: >
                            {{ sensor_name }} dropped below {{ threshold }}%
                            (currently {{ sensor_value }}%).
                            {{ custom_message }}
          default:
            - service: system_log.write
              data:
                level: warning
                message: >
                  No notify.mobile_app_* service found for {{ person_entity }}.
